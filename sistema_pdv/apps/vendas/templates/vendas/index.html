{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- ‚úÖ VERS√ÉO 4.0 FINAL - DEVE APARECER CAIXA VERDE -->
<link rel="stylesheet" href="{% static 'vendas/pdv.css' %}?v=20251124140500">

<section class="pdv-container">
	<div class="pdv-content">
		<!-- Coluna Esquerda: Itens do Pedido -->
		<div class="pedido-section">
			<h2 class="section-title">Itens do Pedido</h2>
			
			<!-- Busca de Produtos -->
			<div class="produto-search">
				<input type="text" id="busca-produto" placeholder="Buscar produto por nome ou c√≥digo..." class="search-input">
				<div id="resultados-busca" class="search-results"></div>
			</div>

			<!-- Lista de Itens -->
			<div class="itens-lista" id="itens-lista">
				{% for item in itens %}
				<div class="item-card" data-item-id="{{ item.id }}">
					<div class="item-info">
						<h4 class="item-nome">{{ item.produto.nome }}</h4>
						<p class="item-preco">R$ {{ item.preco_unitario|floatformat:2 }}</p>
					</div>
					
					<div class="item-controls">
						<button class="btn-qty btn-decrement" data-item-id="{{ item.id }}">‚àí</button>
						<span class="item-qty">{{ item.quantidade }}</span>
						<button class="btn-qty btn-increment" data-item-id="{{ item.id }}">+</button>
						<button class="btn-remove" data-item-id="{{ item.id }}">üóëÔ∏è</button>
					</div>
					
					<div class="item-total">
						R$ <span class="subtotal-valor">{{ item.subtotal|floatformat:2 }}</span>
					</div>
				</div>
				{% empty %}
				<div class="empty-cart">
					<p>Nenhum item adicionado</p>
				</div>
				{% endfor %}
			</div>
		</div>

		<!-- Coluna Direita: Resumo e Pagamento -->
		<div class="resumo-section">
			<h2 class="section-title">Resumo do Pedido</h2>
			
			<!-- Cliente Section -->
			<div class="cliente-card" style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
				<h3 style="font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px;">üë§ Cliente</h3>
				<select id="cliente-select" class="cliente-select" style="width: 100%; padding: 12px; border: 2px solid #d2d2d7; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
					<option value="">Venda An√¥nima</option>
					{% for cliente in clientes %}
					<option value="{{ cliente.id }}" {% if venda.cliente and venda.cliente.id == cliente.id %}selected{% endif %}>{{ cliente.nome }}</option>
					{% endfor %}
				</select>
				<p id="cliente-info" style="margin-top: 8px; font-size: 12px; color: #86868b;">
					{% if venda.cliente %}
						Cliente: {{ venda.cliente.nome }}
					{% else %}
						Nenhum cliente selecionado
					{% endif %}
				</p>
			</div>
			
			<div class="resumo-card">
				<div class="resumo-linha">
					<span>Subtotal:</span>
					<span class="valor">R$ <span id="subtotal">{{ venda.subtotal|floatformat:2 }}</span></span>
				</div>
				
				<div class="resumo-linha desconto-linha">
					<label for="desconto-input">Desconto:</label>
					<input type="number" id="desconto-input" value="{{ venda.desconto|floatformat:2 }}" step="0.01" min="0" class="desconto-input">
				</div>
				
				<div class="resumo-linha frete-linha">
					<label for="frete-input">Frete:</label>
					<input type="number" id="frete-input" value="{{ venda.frete|floatformat:2 }}" step="0.01" min="0" class="frete-input">
				</div>
				
				<div class="resumo-linha total-linha">
					<span>Total:</span>
					<span class="valor-total">R$ <span id="total">{{ venda.total|floatformat:2 }}</span></span>
				</div>
			</div>

		<!-- Formas de Pagamento -->
		<div class="pagamento-card">
			<div style="background: #00ff00; color: #000; padding: 15px; border: 3px solid #000; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: bold; font-size: 18px;">
				‚úÖ VERS√ÉO 4.0 CARREGADA - SE VER ISSO, EST√Å ATUALIZADO!
			</div>
			<h3 class="pagamento-title">Formas de Pagamento</h3>				<div class="pagamento-tabs">
					<button class="tab-btn active" data-tipo="dinheiro">Dinheiro</button>
					<button class="tab-btn" data-tipo="cartao">Cart√£o</button>
					<button class="tab-btn" data-tipo="pix">PIX</button>
				<button class="tab-btn" data-tipo="outros">Outros</button>
			</div>

			<div class="pagamento-inputs">
				<div class="form-group">
					<label>Valor Recebido</label>
					<input type="number" id="valor-recebido" step="0.01" min="0" placeholder="R$ 0,00" class="valor-input">
				</div>
				
				<div class="form-group" id="troco-group">
					<label>Troco</label>
					<input type="text" id="troco" readonly placeholder="R$ 0,00" class="valor-input readonly">
				</div>
				
				<!-- CART√ÉO: D√©bito/Cr√©dito e Parcelas -->
				<div id="cartao-opcoes" style="display: none; margin-top: 16px; padding: 16px; background: white; border: 2px solid #7b2ff7; border-radius: 8px;">
					<div style="margin-bottom: 16px;">
						<label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #1d1d1f;">üí≥ Tipo de Cart√£o</label>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
							<button type="button" class="cartao-tipo-btn" data-tipo="debito" style="padding: 12px; border: 2px solid #7b2ff7; border-radius: 6px; background: linear-gradient(90deg, #7b2ff7, #9b41ff); color: white; font-size: 14px; font-weight: 600; cursor: pointer;">D√©bito</button>
							<button type="button" class="cartao-tipo-btn" data-tipo="credito" style="padding: 12px; border: 2px solid #d2d2d7; border-radius: 6px; background: white; color: #1d1d1f; font-size: 14px; font-weight: 600; cursor: pointer;">Cr√©dito</button>
						</div>
					</div>
					
					<div id="parcelas-group" style="display: none;">
						<label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #1d1d1f;">üìä N√∫mero de Parcelas</label>
						<input type="number" id="parcelas-input" min="1" max="12" value="1" style="width: 100%; padding: 12px; border: 2px solid #d2d2d7; border-radius: 6px; font-size: 16px; font-weight: 600;">
					</div>
				</div>
			</div>		<!-- Valores por forma de pagamento (hidden inputs) -->
		<input type="hidden" id="pagamento-dinheiro" value="0">
		<input type="hidden" id="pagamento-cartao" value="0">
		<input type="hidden" id="pagamento-pix" value="0">
		<input type="hidden" id="pagamento-outros" value="0">
		<input type="hidden" id="cartao-tipo" value="debito">
		<input type="hidden" id="cartao-parcelas" value="1">
	</div>

	<!-- C√≥digo de Barras -->
	<div class="barcode-card">
				<h3 class="barcode-title">C√≥digo de Barras</h3>
				<div class="barcode">
					<div class="barcode-lines">
						<span></span><span></span><span></span><span></span><span></span>
						<span></span><span></span><span></span><span></span><span></span>
						<span></span><span></span><span></span><span></span><span></span>
					</div>
					<p class="barcode-number">{{ venda.codigo_barras }}</p>
				</div>
			</div>

			<!-- Bot√µes de A√ß√£o -->
			<div class="action-buttons">
				<button id="btn-adicionar" class="btn btn-adicionar">Adicionar Item</button>
				<button id="btn-cancelar" class="btn btn-cancelar">Cancelar Venda</button>
				<button id="btn-finalizar" class="btn btn-finalizar">Finalizar Venda</button>
			</div>
		</div>
	</div>
</section>

<!-- Modal de Adicionar Produto -->
<div id="modal-produto" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h3>Selecionar Produto</h3>
			<button class="modal-close">&times;</button>
		</div>
		<div class="modal-body">
			<input type="text" id="modal-busca" placeholder="Buscar produto..." class="search-input">
			<div class="produtos-lista" id="produtos-lista">
				{% for produto in produtos %}
				<div class="produto-item" data-produto-id="{{ produto.id }}" data-produto-nome="{{ produto.nome }}" data-produto-preco="{{ produto.preco }}">
					<div>
						<strong>{{ produto.nome }}</strong>
						<p class="produto-info">R$ {{ produto.preco|floatformat:2 }} - Estoque: {{ produto.estoque }}</p>
					</div>
					<button class="btn-selecionar">Adicionar</button>
				</div>
				{% endfor %}
			</div>
		</div>
	</div>
</div>

<script>
// Script inline para garantir funcionamento imediato - v3.2
console.log('üöÄ Script inline carregado!');

// Adicionar evento aos bot√µes de pagamento
	document.querySelectorAll('.tab-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			const tipo = this.getAttribute('data-tipo');
			console.log('Bot√£o clicado:', tipo);
			
			// Remover active de todos
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			this.classList.add('active');
			
			const cartaoDiv = document.getElementById('cartao-opcoes');
			const trocoDiv = document.getElementById('troco-group');
			const valorRecebidoInput = document.getElementById('valor-recebido');
			const trocoInput = document.getElementById('troco');
			
			// Obter o valor total
			const total = parseFloat(document.getElementById('total').textContent);
			
			// Preencher automaticamente para PIX e Cart√£o
			if (tipo === 'pix' || tipo === 'cartao') {
				if (valorRecebidoInput) valorRecebidoInput.value = total.toFixed(2);
				if (trocoInput) trocoInput.value = '';
			} else {
				if (valorRecebidoInput) valorRecebidoInput.value = '';
				if (trocoInput) trocoInput.value = '';
			}
			
			if (tipo === 'cartao') {
				console.log('Mostrando op√ß√µes de cart√£o');
				if (cartaoDiv) {
					cartaoDiv.style.display = 'block';
				}
				if (trocoDiv) trocoDiv.style.display = 'none';
			} else if (tipo === 'pix') {
				console.log('PIX selecionado - sem troco');
				if (cartaoDiv) cartaoDiv.style.display = 'none';
				if (trocoDiv) trocoDiv.style.display = 'none';
			} else {
				if (cartaoDiv) cartaoDiv.style.display = 'none';
				if (trocoDiv) trocoDiv.style.display = 'block';
			}
		});
	});// Bot√µes de d√©bito/cr√©dito
document.addEventListener('click', function(e) {
	if (e.target.classList.contains('cartao-tipo-btn')) {
		const tipo = e.target.getAttribute('data-tipo');
		
		// Resetar estilos
		document.querySelectorAll('.cartao-tipo-btn').forEach(btn => {
			btn.style.background = 'white';
			btn.style.color = '#1d1d1f';
			btn.style.borderColor = '#d2d2d7';
		});
		
		// Aplicar estilo ativo
		e.target.style.background = 'linear-gradient(90deg, #7b2ff7, #9b41ff)';
		e.target.style.color = 'white';
		e.target.style.borderColor = '#7b2ff7';
		
		const parcelasDiv = document.getElementById('parcelas-group');
		if (tipo === 'credito') {
			if (parcelasDiv) parcelasDiv.style.display = 'block';
		} else {
			if (parcelasDiv) parcelasDiv.style.display = 'none';
		}
	}
});

console.log('‚úÖ Script inline configurado!');
</script>

<script src="{% static 'vendas/pdv.js' %}?v=20251124143000"></script>

{% endblock %}
